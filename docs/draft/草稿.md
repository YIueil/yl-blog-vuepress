# 草稿

## 系统优化步骤。
1. 前端优化，减少表单打开时的请求量。
	- 静态资源考虑使用专门的静态资源服务器部署。
	- 背景图片相关资源进行压缩。
	- 懒加载表单，减少crossui请求，从表单越多，减少的请求越多。
	- 懒加载地图组件js。减少近400个请求，包括js和css。
	- 架构升级，vue-cli版本升级。
2. 索引优化。
	- 业务表索引
		- BZ_开头的表。
		- APP_表。
		- 业务Entity表。
	- 产品表索引
		- PCC_开头表
		- 其他模型相关表。
	- DASC安全表索引，USER，ROLE，ACE等表。
	- Activiti 流程信息表索引。
3. 服务器层面，增加两台应用服务器，使用NGINX代理，启用权重方式，使用更符合现状的负载策略。
	- 最小连接数+被动监测，超时记录错误，达到错误上线数时，临时下线错误节点。
		- 请求超过2分钟判断为错误，错误数+1
		- 错误数达到5次时将错误节点临时下线1天。
```nginx
worker_processes  1;

events {
    worker_connections  1024;
}

http {
    upstream testStream {
        least_conn;
        server 127.0.0.1:18080 max_fails=3 fail_timeout=30s;
        server 127.0.0.1:18081 max_fails=3 fail_timeout=30s;
    }

    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    server {
        listen       80;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
            # 被动健康检查的核心配置
            proxy_connect_timeout 3s;     # 连接超时
            proxy_send_timeout 10s;       # 发送超时
            proxy_read_timeout 5s;        # 读取超时（关键！设置为较短时间）

            # 触发失败的条件
            proxy_next_upstream error timeout;

            proxy_pass http://testStream;
        }

        location /nginx_status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            deny all;
        }
    }
}

```
4. 应用层面
	- 数据字典优化，前端统一获取字典请求。
	- 材料加载优化。
	- 保存优化。
	- SQL相关内容优化。
		- 子查询拆分。
		- 关联字段索引添加。
		- 关联逻辑优化。
		- 数据查询到数字的sql修改，去除非必要的表。
## 增加应用节点步骤
### 1 创建用户
```sh
# 修改主机名称
hostnamectl set-hostname ytgz-27

useradd app
# 修改密码
passwd app

# 添加目录 授权给app
mkdir -p /opt/app/ytgz
mkdir -p /opt/file

chown -R app /opt/app/ytgz
chown -R app /opt/file
```

### 2 安装JDK1.8
```sh
# 使用 RPM 命令安装
rpm -ivh jdk-8u202-linux-x64.rpm
```

### 3 安装字体
```sh
# 安装字体管理依赖
yum -y localinstall *.rpm

# 复制字体
cp -r winfonts /usr/share/fonts

# 刷新字体
sudo fc-cache –fv

# 查看安装的字体
fc-list
```

### 4 挂载磁盘
```sh
# 挂载
mount -t cifs -o iocharset=utf8,username=gt_ytgz,password=yn_299792458,vers=1.0,rw,uid=app,gid=app //9.77.254.117/gt_ytgz /opt/file

# 查看磁盘信息
[root@ytgz-152 2.党政字体]# df -h
Filesystem              Size  Used Avail Use% Mounted on
devtmpfs                7.8G     0  7.8G   0% /dev
tmpfs                   7.8G     0  7.8G   0% /dev/shm
tmpfs                   7.8G   17M  7.8G   1% /run
tmpfs                   7.8G     0  7.8G   0% /sys/fs/cgroup
/dev/vda1               100G  2.7G   98G   3% /
tmpfs                   1.6G     0  1.6G   0% /run/user/0
tmpfs                   1.6G     0  1.6G   0% /run/user/1001
//9.77.254.117/gt_ytgz  256T  145T  112T  57% /opt/file

```

### 5 启动应用
```sh
cd /opt/app/ytgz/apache-tomcat-9.0.106-app-7150/bin

# 启动
./startup.sh
```
